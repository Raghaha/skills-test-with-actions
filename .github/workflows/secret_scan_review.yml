name: review secrets findings in ghas

on:
  workflow_dispatch:

permissions:
  security-events: read

jobs:
  curl_to_github:
    runs-on: ubuntu-latest
    
    #outputs:
     # found_secret: ${{ steps.read_secret_scan.outputs.scanned_secret }}
      
    steps: 
      - name: Fetching $ {{ vars.SECRET_TYPE }} from github
        run: |
          API_RESPONSE=$(curl -L -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.GHAS_PAT }}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          "https://api.github.com/repos/Raghaha/skills-test-with-actions/secret-scanning/alerts?secret_type=${{ vars.SECRET_TYPE }}" \
          | jq '.[]' | jq -r '[.html_url, .secret_type, .secret]| @csv')
          
          if [ -z "$API_RESPONSE" ]; then
            echo "No github PAT found."
            exit 0
          else
            echo "Github PAT found"
          fi
          
          echo "Validating extracted GitHub PAT..."
          echo ""
          
          for ROW in $API_RESPONSE; do
            
            GH_SECRET=$(echo ${ROW} | cut -d\, -f3)
            HTTP_STATUS=$(curl -s -I -H "Authorization: Bearer $GH_SECRET" ${{ GH_VER_API }} | grep HTTP | cut -d\  -f2)
          
            if [ "$HTTP_STATUS" -eq 200 ]; then
              echo The extracted GitHub secret in $( echo ${ROW} | cut -d\, -f1) is valid.
              
            else
              echo The extracted GitHub secret in $( echo ${ROW} | cut -d\, -f1) is invalid.
              echo You can close the finding with suitable justification.
              
            fi
            
            echo ""
            echo ""
          
          done
